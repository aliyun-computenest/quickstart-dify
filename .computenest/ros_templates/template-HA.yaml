ROSTemplateFormatVersion: '2015-09-01'
Description:
  zh-cn: 创建托管Kubernetes集群，配置VPC、节点池、HPA及日志服务，实现Dify应用的自动伸缩与监控。
  en: Create a managed Kubernetes cluster, configure Virtual Private Cloud (VPC), node pools, Horizontal Pod Autoscaler (HPA), and logging services to enable automatic scaling and monitoring of containerized applications.
Locals:
  Repo:
    Value:
      Fn::Sub:
        - registry-${Region}-vpc.ack.aliyuncs.com/acs
        - Region:
            Ref: ALIYUN::Region
Conditions:
  EnableTLSConfigConditions:
    Fn::Equals:
      - true
      - Ref: EnableTLSConfig
  EnableHPAConditions:
    Fn::Equals:
      - true
      - Ref: HPAOption
  CreateAck:
    Fn::Equals:
      - Ref: AckOptions
      - NewAck
  ExistedAck:
    Fn::Equals:
      - Ref: AckOptions
      - ExistCs
  UserChooseVpc:
    Fn::Or:
      - Fn::Equals:
        - Ref: AckOptions
        - ExistCs
      - Fn::Equals:
        - Ref: VpcOption
        - ExistingVPC
Parameters:
  AckOptions:
    AssociationPropertyMetadata:
      ValueLabelMapping:
        ExistCs:
          zh-cn: 已有容器集群
          en: New ACK
        NewAck:
          zh-cn: 新建容器集群
          en: Existing ACK
    Description:
      zh-cn: 选择已有容器集群时，避免给您的其他服务造成影响，<font color='green'>部署完成后需自行配置服务访问。<br><font
      en: Enable the TLS configuration to ensure data security during transmission using encryption technologies and protocols<br> <font color='green'>To enable the TLS configuration, you need to configure the TLS certificate and password<br><font
    Default: ExistCs
    Required: true
    AllowedValues:
      - ExistCs
      - NewAck
    Label: 选择已有/新建的容器集群
    Type: String
  VpcOption:
    Type: String
    AllowedValues:
      - NewVPC
      - ExistingVPC
    AssociationPropertyMetadata:
      ValueLabelMapping:
        NewVPC:
          zh-cn: 新建专有网络
          en: New VPC
        ExistingVPC:
          zh-cn: 已有专有网络
          en: Existing VPC
      Visible:
        Condition:
          Fn::Equals:
            - ${AckOptions}
            - NewAck
    Label:
      en: Select Existing or New VPC
      zh-cn: 选择已有/新建的专有网络
    Required: true
    Default: NewVPC
  HPAOption:
    Type: Boolean
    Label:
      en: Whether to enable high availability configuration.
      zh-cn: 是否启用高可用配置
    Description:
      zh-cn: 启用高可用配置，可以提高应用的容灾和对峰值负载的处理能力<br> <font color='green'>1. Dify的核心业务组件会配置多副本，并打散到不同节点，尽量避免单节点、或单AZ故障造成应用整体服务不可用。<br><font color='green'>2. 为资源消耗密集的组件增加弹性伸缩配置，更好应对峰值负载的压力。</font><br>
      en: The HA configuration can improve the disaster recovery and peak load processing capability of applications<br> <font color='green'>1. Multiple replicas are configured for the core service components of Dify and distributed to different nodes to prevent the failure of a single node or AZ from making the entire application service unavailable.<br><font color='green'>2. Add elastic scaling to resource-intensive components to better cope with peak load stress.</font><br>
    Default: true
  AutoScalingOption:
    Type: Boolean
    Label:
      en: Whether to enable automatic elastic scaling of a node pool.
      zh-cn: 节点池是否启用自动弹性伸缩
    Description:
      zh-cn: 节点池若开启自动弹性伸缩，付费方式只能选择按量付费
      en: If automatic elastic expansion is enabled for a node pool, the payment mode can only be Postpaid
    Default: false
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Equals:
            - ${AckOptions}
            - NewAck
  AckNetworkPlugin:
    Type: String
    Label:
      en: ACK plugin network
      zh-cn: ACK 网络插件
    AllowedValues:
      - terway
      - flannel
    Default: terway
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Equals:
            - ${AckOptions}
            - NewAck
  DomainAddress:
    Type: String
    Label:
      en: Domain
      zh-cn: 域名
    Default: dify-example.local
    Description:
      en: Please enter a valid domain name
      zh-cn: 请输入有效的域名
    AllowedPattern: ^(?!-)[A-Za-z0-9-]{1,63}(?<!-)(\.[A-Za-z]{2,})+$
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Equals:
            - ${AckOptions}
            - NewAck
  EnableTLSConfig:
    Type: Boolean
    Label:
      en: Whether to enable TLS configuration.
      zh-cn: 是否开启TLS配置
    Description:
      zh-cn: 开启TLS配置，通过加密技术和协议来确保数据在传输过程中的安全<br> <font color='green'>开启TLS配置需要配置TLS证书和密码。<br><font
      en: Enable the TLS configuration to ensure data security during transmission using encryption technologies and protocols<br> <font color='green'>To enable the TLS configuration, you need to configure the TLS certificate and password<br><font
    Default: false
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Equals:
            - ${AckOptions}
            - NewAck
  TLSCert:
    Type: String
    Default: ''
    Label:
      en: TLS Cert.
      zh-cn: TLS Cert证书
    NoEcho: true
    Required:
      Fn::Equals:
        - true
        - ${EnableTLSConfig}
    AssociationProperty: FileContent
    AssociationPropertyMetadata:
      AcceptFileSuffixes: .crt
      Visible:
        Condition:
          Fn::Equals:
            - true
            - ${EnableTLSConfig}
  TLSSecret:
    Type: String
    Default: ''
    Label:
      en: TLS Secret.
      zh-cn: TLS 密钥
    NoEcho: true
    Required:
      Fn::Equals:
        - true
        - ${EnableTLSConfig}
    AssociationProperty: FileContent
    AssociationPropertyMetadata:
      AcceptFileSuffixes: .key
      Visible:
        Condition:
          Fn::Equals:
            - true
            - ${EnableTLSConfig}
  PayType:
    Type: String
    Label:
      en: ECS Instance Charge Type
      zh-cn: 付费类型
    Default: PostPaid
    AllowedValues:
      - PostPaid
      - PrePaid
    AssociationProperty: ChargeType
    AssociationPropertyMetadata:
      LocaleKey: InstanceChargeType
      AllowedValues:
        - Condition:
            Fn::Equals:
              - ${AutoScalingOption}
              - false
          Value:
            - PostPaid
            - PrePaid
        - Condition:
            Fn::Equals:
              - ${AutoScalingOption}
              - true
          Value:
            - PostPaid
  PayPeriodUnit:
    Type: String
    Label:
      en: Pay Period Unit
      zh-cn: 购买资源时长周期
    Default: Month
    AllowedValues:
      - Month
      - Year
    AssociationProperty: PayPeriodUnit
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Not:
            Fn::Equals:
              - ${PayType}
              - PostPaid
  PayPeriod:
    Type: Number
    Label:
      en: Period
      zh-cn: 购买资源时长
    Default: 1
    AllowedValues:
      - 1
      - 2
      - 3
      - 4
      - 5
      - 6
      - 7
      - 8
      - 9
    AssociationProperty: PayPeriod
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Not:
            Fn::Equals:
              - ${PayType}
              - PostPaid
  VpcCidrBlock:
    Type: String
    Label:
      en: VPC CIDR IPv4 Block
      zh-cn: 专有网络IPv4网段
    Description:
      zh-cn: VPC的ip地址段范围，<br>您可以使用以下的ip地址段或其子网:<br><font color='green'>[10.0.0.0/8]</font><br><font color='green'>[172.16.0.0/12]</font><br><font color='green'>[192.168.0.0/16]</font>
      en: 'The ip address range of the VPC in the CidrBlock form; <br>You can use the following ip address ranges and their subnets: <br><font color=''green''>[10.0.0.0/8]</font><br><font color=''green''>[172.16.0.0/12]</font><br><font color=''green''>[192.168.0.0/16]</font>'
    Default: 192.168.0.0/16
    Required:
      Fn::Equals:
        - NewVPC
        - ${VpcOption}
    AssociationProperty: ALIYUN::VPC::VPC::CidrBlock
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Equals:
            - NewVPC
            - ${VpcOption}
  VSwitchCidrBlock1:
    Type: String
    Label:
      en: VSwitch CIDR Block
      zh-cn: 交换机子网网段1
    Description:
      zh-cn: 必须属于VPC的子网段。
      en: Must belong to the subnet segment of VPC.
    Default: 192.168.0.0/24
    Required:
      Fn::Equals:
        - NewVPC
        - ${VpcOption}
    AssociationProperty: ALIYUN::VPC::VSwitch::CidrBlock
    AssociationPropertyMetadata:
      VpcCidrBlock: VpcCidrBlock
      Visible:
        Condition:
          Fn::Equals:
            - NewVPC
            - ${VpcOption}
  VSwitchCidrBlock2:
    Type: String
    Label:
      en: VSwitch CIDR Block
      zh-cn: 交换机子网网段2
    Description:
      zh-cn: 必须属于VPC的子网段。
      en: Must belong to the subnet segment of VPC.
    Default: 192.168.1.0/24
    Required:
      Fn::Equals:
        - NewVPC
        - ${VpcOption}
    AssociationProperty: ALIYUN::VPC::VSwitch::CidrBlock
    AssociationPropertyMetadata:
      VpcCidrBlock: VpcCidrBlock
      Visible:
        Condition:
          Fn::Equals:
            - NewVPC
            - ${VpcOption}
  PodCidr:
    Type: String
    Description:
      zh-cn: 请填写有效的私有网段，即以下网段及其子网：10.0.0.0/8，172.16-31.0.0/12-16，192.168.0.0/16<br>不能与 VPC 及 VPC 内已有 Kubernetes 集群使用的网段重复。<font color='blue'><b>创建成功后不能修改</b></font>
      en: 'Please fill in a valid private segment, i.e. the following segments and their subnets: 10.0.0.0/8, 172.16-31.0.0/12-16, 192.168.0.0/16<br> which cannot duplicate the network segments already used by clusters in VPC and VPC Kunetberes. <font color=''blue''><b>Cannot be modified after successful creation</b></font>'
    Label:
      zh-cn: Pod 网络 CIDR
      en: Pod Network CIDR
    AssociationProperty: ALIYUN::CS::ManagedKubernetesCluster::PodCidr
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Equals:
            - ${AckNetworkPlugin}
            - flannel
    Default: 172.20.0.0/20
  ServiceCidr:
    Type: String
    Description:
      zh-cn: 可选范围：10.0.0.0/16-24，172.16-31.0.0/16-24，192.168.0.0/16-24<br>不能与 VPC 及 VPC 内已有 Kubernetes 集群使用的网段重复。<font color='blue'><b>创建成功后不能修改</b></font>
      en: 'Optional range: 10.0.0.0/16-24, 172.16-31.0.0/16-24, 192.168.0.0/16-24<br> cannot duplicate segments already used by existing Kubernetes clusters in VPC and VPC.<font color=''blue''><b>Cannot be modified after successful creation</b></font>'
    Label:
      zh-cn: Service CIDR
      en: Service CIDR
    AssociationProperty: ALIYUN::CS::ManagedKubernetesCluster::ServiceCidr
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Equals:
            - ${AckOptions}
            - NewAck
    Default: 172.16.0.0/16
  ZoneId1:
    Type: String
    AssociationProperty: ALIYUN::ECS::Instance::ZoneId
    AssociationPropertyMetadata:
      ExclusiveTo:
        - ZoneId2
    Label:
      en: Availability Zone
      zh-cn: 可用区1
  ZoneId2:
    Type: String
    AssociationProperty: ALIYUN::ECS::Instance::ZoneId
    AssociationPropertyMetadata:
      ExclusiveTo:
        - ZoneId1
    Label:
      en: Availability Zone
      zh-cn: 可用区2
  VpcId:
    Type: String
    Label:
      en: VPC ID
      zh-cn: 专有网络VPC实例ID
    Description: <br> <font color='red'>如果选择“已有容器集群”, 此VPC务必选择有容器集群所在的VPC<br><font>
    AssociationProperty: ALIYUN::ECS::VPC::VPCId
    Required:
      Fn::Or:
        - Fn::Equals:
            - ${AckOptions}
            - ExistCs
        - Fn::Equals:
            - ${VpcOption}
            - ExistingVPC
    Default: ''
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Or:
            - Fn::Equals:
                - ${AckOptions}
                - ExistCs
            - Fn::Equals:
                - ${VpcOption}
                - ExistingVPC
  VSwitchId1:
    Type: String
    Label:
      en: VSwitch ID
      zh-cn: 交换机实例ID
    Default: ''
    AssociationProperty: ALIYUN::ECS::VSwitch::VSwitchId
    Required:
      Fn::Or:
        - Fn::Equals:
            - ${AckOptions}
            - ExistCs
        - Fn::Equals:
            - ${VpcOption}
            - ExistingVPC
    AssociationPropertyMetadata:
      VpcId: VpcId
      ZoneId: ZoneId1
      Visible:
        Condition:
          Fn::Or:
            - Fn::Equals:
                - ${AckOptions}
                - ExistCs
            - Fn::Equals:
                - ${VpcOption}
                - ExistingVPC
  VSwitchId2:
    Type: String
    Label:
      en: VSwitch ID
      zh-cn: 交换机实例ID
    Default: ''
    AssociationProperty: ALIYUN::ECS::VSwitch::VSwitchId
    Required:
      Fn::Or:
        - Fn::Equals:
            - ${AckOptions}
            - ExistCs
        - Fn::Equals:
            - ${VpcOption}
            - ExistingVPC
    AssociationPropertyMetadata:
      VpcId: VpcId
      ZoneId: ZoneId2
      Visible:
        Condition:
          Fn::Or:
            - Fn::Equals:
                - ${AckOptions}
                - ExistCs
            - Fn::Equals:
                - ${VpcOption}
                - ExistingVPC
  ClusterId:
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Equals:
            - ${AckOptions}
            - ExistCs
      RegionId: ${RegionId}
      ClusterType: ManagedKubernetes
      Profile: Default
    Description: 部署应用程序的ACK集群ID, 此处仅支持ACK 托管集群，包括 ACK 集群 Pro 版和 ACK 集群基础版。
    Default: Null
    Required: true
    Label: ACK 集群ID
    AllowedPattern: '[0-9a-z]+$'
    AssociationProperty: ALIYUN::CS::Cluster::ClusterId
    Type: String
  InstanceType:
    Type: CommaDelimitedList
    Default: 
      - ecs.u1-c1m2.xlarge
    AssociationProperty: ALIYUN::ECS::Instance::InstanceType
    AssociationPropertyMetadata:
      CreateACKClusterParams:
        NetworkPlugin: terway-eniip
      Constraints:
        InstanceTypeFamily:
          - ecs.u1
      Visible:
        Condition:
          Fn::Equals:
            - ${AckOptions}
            - NewAck
    AllowedValues:
      - ecs.u1-c1m2.xlarge
      - ecs.u1-c1m4.xlarge
      - ecs.u1-c1m8.xlarge
      - ecs.u1-c1m1.2xlarge
      - ecs.u1-c1m2.2xlarge
      - ecs.u1-c1m4.2xlarge
      - ecs.u1-c1m8.2xlarge
      - ecs.u1-c1m1.3xlarge
      - ecs.u1-c1m2.3xlarge
      - ecs.u1-c1m4.3xlarge
      - ecs.u1-c1m8.3xlarge
      - ecs.u1-c1m1.4xlarge
      - ecs.u1-c1m2.4xlarge
      - ecs.u1-c1m4.4xlarge
      - ecs.u1-c1m8.4xlarge
      - ecs.u1-c1m1.8xlarge
      - ecs.u1-c1m2.8xlarge
      - ecs.u1-c1m4.8xlarge
      - ecs.u1-c1m8.8xlarge
    Label:
      en: Worker Instance Type
      zh-cn: Worker 节点实例规格
  WorkerSystemDiskSize:
    Default: 120
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Equals:
            - ${AckOptions}
            - NewAck
    Label: Worker节点系统盘大小(GB)
    Type: Number
    MinValue: 1
  WorkerSystemDiskCategory:
    Type: String
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Equals:
            - ${AckOptions}
            - NewAck
      LocaleKey: DiskCategory
      InstanceType: ${InstanceType}
    Default: cloud_essd
    AllowedValues:
      - cloud_efficiency
      - cloud_ssd
      - cloud_essd
  InstancePassword:
    Default: Null
    NoEcho: true
    Type: String
    Description:
      en: Server login password, Length 8-30, must contain three(Capital letters, lowercase letters, numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol in)
      zh-cn: 服务器登录密码,长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）
    Label:
      en: Instance Password
      zh-cn: 实例密码
    AllowedPattern: '[0-9A-Za-z\_\-\&:;''<>,=%`~!@#\(\)\$\^\*\+\|\{\}\[\]\.\?\/]+$'
    ConstraintDescription:
      en: Length 8-30, must contain three(Capital letters, lowercase letters, numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol in)
      zh-cn: 长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）
    AssociationProperty: ALIYUN::ECS::Instance::Password
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Equals:
            - ${AckOptions}
            - NewAck
  WorkerInstanceCount:
    Default: 3
    Type: Number
    Label:
      zh-cn: 实例节点数
      en: The count for cpu instance.
    MinValue: 1
    MaxValue: 5000
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::And:
            - Fn::Equals:
                - ${AckOptions}
                - NewAck
            - Fn::Equals:
                - ${AutoScalingOption}
                - false
  WorkerInstanceMinCount:
    Default: 3
    Type: Number
    Label:
      zh-cn: 最小实例节点数
      en: The min count for cpu instance.
    MinValue: 1
    MaxValue: 5000
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::And:
            - Fn::Equals:
                - ${AckOptions}
                - NewAck
            - Fn::Equals:
                - ${AutoScalingOption}
                - true
  WorkerInstanceMaxCount:
    Default: 10
    Type: Number
    Label:
      zh-cn: 最大实例节点数
      en: The max count for cpu instance.
    Description:
      en: If you want to enable automatic elastic scaling, the number of nodes must be greater than the minimum.
      zh-cn: 若需要启用自动弹性伸缩，需要大于最小节点数。
    MinValue: 1
    MaxValue: 5000
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::And:
            - Fn::Equals:
                - ${AckOptions}
                - NewAck
            - Fn::Equals:
                - ${AutoScalingOption}
                - true
  RedisInstancePassword:
    Default: Null
    Type: String
    Description:
      zh-cn: 长度8-30，必须包含大写字母、小写字母、数字、特殊符号三个；<br>特殊字符包括：!@#$%^&*()_+-=
      en: The 8-30 long login password of instance, consists of the uppercase, lowercase letter and number. <br> special characters include!@#$%^&*()_+-=
    Label:
      zh-cn: Redis实例密码
      en: Redis Instance Password
    NoEcho: true
    Required: true
    ConstraintDescription:
      en: Length 8-30, must contain three(Capital letters, lowercase letters, numbers,Special symbol in)
      zh-cn: 长度8-30，必须包含三项（大写字母、小写字母、数字、 !@#$%^&*()_+-=中的特殊符号）
    AllowedPattern: '^[0-9A-Za-z_!@#$%^&*()_+\-=\+]+$'
    MinLength: 8
    MaxLength: 30
  DBInstanceClass:
    Type: String
    Label:
      zh-cn: PostgreSQL实例规格
      en: PostgreSQL Instance Class
    Description:
      zh-cn: 根据数据库引擎的类型和可用的区域支持选择实例规格；<br>请参见详细信息：<a href='https://help.aliyun.com/document_detail/26312.html' target='_blank'><b><font color='blue'>实例规格表</font></b></a>
      en: Select the instance specification based on the type of database engine and the available area support;<br>see detail <a href='https://www.alibabacloud.com/help/doc-detail/26312.html' target='_blank'><b><font color='blue'>Instance specification sheet</font></b></a>
    Required: true
    AssociationProperty: ALIYUN::RDS::Instance::InstanceType
    AssociationPropertyMetadata:
      Engine: PostgreSQL
      ZoneId: ${ZoneId1}
    Default: pg.n4.2c.2m
  DBInstanceStorage:
    Type: Number
    Label:
      zh-cn: PostgreSQL实例存储
      en: Storage
    Description:
      zh-cn: RDS实例大小范围为20-2000，每5个增量，单位为GB
      en: The size range of RDS instances is 20 - 2000, Incrementing in every 5, unit GB
    Required: true
    ConstraintDescription:
      zh-cn: RDS实例大小范围为20-2000，每5个增量，单位为GB
      en: The size range of RDS instances is 20 - 2000, Incrementing in every 5, unit GB
    Default: 200
    MinValue: 20
    MaxValue: 2000
  DBInstanceStorageType:
    Type: String
    Label:
      zh-cn: PostgreSQL实例存储类型
      en: Storage Type
    Description:
      zh-cn: 实例存储类型；<br>请参见详细信息：<a href='https://help.aliyun.com/document_detail/69795.html' target='_blank'><b><font color='blue'>存储类型</font></b></a>
      en: The storage type of DB instance; see detail <a href='https://www.alibabacloud.com/help/en/apsaradb-for-rds/latest/storage-types' target='_blank'><b><font color=''blue''>Storage types</font></b></a>'
    Required: true
    AllowedValues:
      - cloud_essd
      - cloud_essd2
      - cloud_essd3
    Default: cloud_essd
  PostgresSQLUserName:
    Type: String
    Description:
      en: Primary account name of the database instance.
      zh-cn: PostgresSQL数据库实例的主账号名称。
    Required: true
    ConstraintDescription:
      en: Consist of 2 to 16 characters of lowercase letters, underline. Must begin with a letter and be end with an alphanumeric character
      zh-cn: 由 2 到 16 个小写字母组成，下划线。必须以字母开头，以字母数字字符结尾
    Label:
      zh-cn: PostgresSQL数据库账号名称
      en: PostgresSQL Username
    Default: postgres
    MaxLength: 16
    MinLength: 2
  PostgresSQLPassword:
    Default: Null
    NoEcho: true
    Type: String
    Description:
      en: Server login password, Length 8-30, must contain three(Capital letters, lowercase letters, numbers, !@#$%^&*()_+-= Special symbol in)
      zh-cn: 数据库访问密码,长度8-30，必须包含三项（大写字母、小写字母、数字、 !@#$%^&*()_+-= 中的特殊符号）
    Label:
      en: Instance Password
      zh-cn: PostgresSQL数据库密码
    ConstraintDescription:
      en: Length 8-30, must contain three(Capital letters, lowercase letters, numbers, !@#$%^&*()_+-=Special symbol in)
      zh-cn: 长度8-30，必须包含三项（大写字母、小写字母、数字、 !@#$%^&*()_+-=中的特殊符号）
    Required: true
    AllowedPattern: '^[0-9A-Za-z_!@#$%^&*()_+\-=\+]+$'
    MinLength: 8
    MaxLength: 30
  ADBPGInstanceSpec:
    Type: String
    Label:
      en: AnalyticDB DBInstanceSpec
      zh-cn: AnalyticDB 实例规格
    AssociationProperty: ALIYUN::GPDB::DBInstance:InstanceSpec
    Default: 4C16G
    Required: true
    AllowedValues:
      - 4C16G
      - 8C32G
      - 16C64G
  ADBPGSegmentStorage:
    Type: Number
    AssociationProperty: ALIYUN::ECS::Instance::StorageSize
    Label:
      en: SegmentStorageSize
      zh-cn: AnalyticDB Segment存储大小(G)
    Default: 200
    Required: true
    AllowedValues:
      - 200
      - 400
      - 800
      - 1024
  ADBPGAccount:
    Type: String
    Description:
      en: Primary account name of the database instance.
      zh-cn: ADBPG 数据库实例的主账号名称。
    ConstraintDescription:
      en: Consist of 2 to 16 characters of lowercase letters, underline. Must begin with a letter and be end with an alphanumeric character
      zh-cn: 由 2 到 16 个小写字母组成，下划线。必须以字母开头，以字母数字字符结尾
    Label:
      zh-cn: ADBPG数据库账号名称
      en: ADBPG Account
    Default: dify
    MaxLength: 16
    MinLength: 2
    Required: true
  ADBPGPassword:
    Default: Null
    NoEcho: true
    Type: String
    Description:
      en: Server login password, Length 8-30, must contain three(Capital letters, lowercase letters, numbers, (!@#$%^&*()_+-=) Special symbol in)
      zh-cn: 数据库访问密码,长度8-30，必须包含三项（大写字母、小写字母、数字、 (!@#$%^&*()_+-=) 中的特殊符号）
    Label:
      en: Instance Password
      zh-cn: ADBPG 数据库密码
    ConstraintDescription:
      en: Length 8-30, must contain three(Capital letters, lowercase letters, numbers,(!@#$%^&*()_+-=)Special symbol in)
      zh-cn: 长度8-30，必须包含三项（大写字母、小写字母、数字、(!@#$%^&*()_+-=)中的特殊符号）
    AllowedPattern: '^[0-9A-Za-z_!@#$%^&*()_+\-=\+]+$'
    MinLength: 8
    MaxLength: 30
    Required: true
  HelmValues:
    Type: Json
    Label:
      en: helm values
      zh-cn: helm配置
    Description:
      zh-cn: 推荐使用默认值
    Default:
      image:
        api:
          tag: 1.1.3
          pullPolicy: IfNotPresent
        web:
          tag: 1.1.3
          pullPolicy: IfNotPresent
        sandbox:
          tag: 0.2.11
          pullPolicy: IfNotPresent
        pluginDaemon:
          pullPolicy: IfNotPresent
          tag: 0.0.6-local
        proxy:
          tag: 1.27.0
          pullPolicy: IfNotPresent
        ssrfProxy:
          tag: latest
          pullPolicy: IfNotPresent
Resources:
  VpcModule:
    Version: v1
    Type: MODULE::ACS::ComputeNest::VpcAndVSwitch
    Condition: CreateAck
    Properties:
      EnableDualZones: true
      VSwitchCidrBlockSecondary:
        Ref: VSwitchCidrBlock2
      VpcId:
        Ref: VpcId
      ZoneIdSecondary:
        Ref: ZoneId2
      VSwitchCidrBlock:
        Ref: VSwitchCidrBlock1
      VpcCidrBlock:
        Ref: VpcCidrBlock
      ZoneId:
        Ref: ZoneId1
      VSwitchIdSecondary:
        Ref: VSwitchId2
      VSwitchId:
        Ref: VSwitchId1
      VpcOption:
        Ref: VpcOption
  RedisInstance:
    Type: ALIYUN::REDIS::Instance
    Properties:
      ChargeType:
        Ref: PayType
      PeriodUnit:
        Ref: PayPeriodUnit
      Period:
        Ref: PayPeriod
      VpcId:
        Fn::If: 
          - UserChooseVpc
          - Ref: VpcId
          - Fn::GetAtt:
            - AckModule
            - ClusterVpcId
      VSwitchId:
        Fn::If: 
          - UserChooseVpc
          - Ref: VSwitchId1
          - Fn::GetAtt:
            - AckModule
            - ClusterVSwitchId
      ZoneId:
        Ref: ZoneId1
      InstanceClass: redis.master.mid.default
      ShardCount: 2
      EngineVersion: '5.0'
      EvictionPolicy: noeviction
      InstanceName:
        Ref: ALIYUN::StackName
      Password:
        Ref: RedisInstancePassword
  RedisWhitelist:
    Type: ALIYUN::REDIS::Whitelist
    Properties:
      SecurityIpGroupAttribute: default
      SecurityIps:
        Fn::Join:
          - ','
          - - Ref: ServiceCidr
            - Ref: PodCidr
            - Fn::GetAtt:
                - AckModule
                - ClusterVpcCidr
      InstanceId:
        Ref: RedisInstance
  PostgreSQLInstance:
    Type: ALIYUN::RDS::DBInstance
    Properties:
      ZoneId:
         Ref: ZoneId1
      VpcId:
        Fn::If: 
          - UserChooseVpc
          - Ref: VpcId
          - Fn::GetAtt:
            - AckModule
            - ClusterVpcId
      VSwitchId:
        Fn::If: 
          - UserChooseVpc
          - Ref: VSwitchId1
          - Fn::GetAtt:
            - AckModule
            - ClusterVSwitchId
      Engine: PostgreSQL
      EngineVersion: '14.0'
      DBInstanceClass:
        Ref: DBInstanceClass
      DBInstanceStorage:
        Ref: DBInstanceStorage
      DBInstanceStorageType:
        Ref: DBInstanceStorageType
      Category: HighAvailability
      MasterUserType: Super
      DBInstanceNetType: Intranet
      MasterUserPassword:
        Ref: PostgresSQLPassword
      MasterUsername:
        Ref: PostgresSQLUserName
      PayType:
        Ref: PayType
      PeriodType:
        Ref: PayPeriodUnit
      Period:
        Ref: PayPeriod
      SecurityIPList:
        Fn::Join:
          - ','
          - - Ref: ServiceCidr
            - Ref: PodCidr
            - Fn::GetAtt:
                - AckModule
                - ClusterVpcCidr
  OSSBucket:
    Type: 'ALIYUN::OSS::Bucket'
    Properties:
      DeletionForce: true
      RedundancyType: LRS
      CORSConfiguration:
        CORSRule:
        - AllowedHeader: ['*']
          AllowedMethod: [HEAD, GET, PUT, POST, DELETE]
          AllowedOrigin: ['*']
      BucketName:
        Fn::Join:
          - '-'
          - - 'dify'
            - Ref: ALIYUN::StackName
  SuperOpsUser:
    Type: 'ALIYUN::RAM::User'
    Properties:
      UserName:
        'Fn::Join':
        - '-'
        - - SuperOps
          - Ref: ALIYUN::StackName
      Policies:
      - PolicyName:
          'Fn::Join':
          - '-'
          - - DifySuperOpsPolicy
            - Ref: 'ALIYUN::StackName'
        PolicyDocument:
          Version: '1'
          Statement:
          - Effect: Allow
            Action:
            - 'gpdb:*'
            Resource:
            - '*'
          - Effect: Allow
            Action:
            - '*'
            Resource:
            - 'Fn::Sub':
              - 'acs:oss:*:*:${BucketName}*'
              - BucketName:
                  Fn::Join:
                    - '-'
                    - - 'dify'
                      - Ref: ALIYUN::StackName
      PolicyAttachments:
        System:
        - AliyunSTSAssumeRoleAccess
        - AliyunRAMReadOnlyAccess
  AccessKey:
    Type: 'ALIYUN::RAM::AccessKey'
    Properties:
      UserName:
        'Fn::GetAtt':
        - SuperOpsUser
        - UserName
  DifyDataBase:
    Type: ALIYUN::RDS::Database
    Properties:
      CharacterSetName: UTF8
      DBInstanceId:
        Fn::GetAtt:
          - PostgreSQLInstance
          - DBInstanceId
      DBName: dify
  DifySetUpDataBase:
    Type: ALIYUN::RDS::Database
    Properties:
      CharacterSetName: UTF8
      DBInstanceId:
        Fn::GetAtt:
          - PostgreSQLInstance
          - DBInstanceId
      DBName: dify_setups
  ADBPGInstance:
    Type: ALIYUN::GPDB::DBInstance
    Properties:
      MasterNodeNum: 1
      SegNodeNum: 4
      InstanceSpec:
        Ref: ADBPGInstanceSpec
      VectorConfigurationStatus: true
      EngineVersion: '6.0'
      ZoneId:
        Ref: ZoneId1
      VPCId:
        Fn::If: 
          - UserChooseVpc
          - Ref: VpcId
          - Fn::GetAtt:
            - AckModule
            - ClusterVpcId
      PayType:
        Ref: PayType
      VSwitchId:
        Fn::If: 
          - UserChooseVpc
          - Ref: VSwitchId1
          - Fn::GetAtt:
            - AckModule
            - ClusterVSwitchId
      Period:
        Ref: PayPeriod
      PeriodUnit:
        Ref: PayPeriodUnit
      DBInstanceCategory: Basic
      SegStorageType: cloud_essd
      StorageSize:
        Ref: ADBPGSegmentStorage
      DBInstanceMode: StorageElastic
      SecurityIPList:
        Fn::Join:
          - ','
          - - Ref: ServiceCidr
            - Ref: PodCidr
            - Fn::GetAtt:
                - AckModule
                - ClusterVpcCidr
  GPDBAccount:
    Type: ALIYUN::GPDB::Account
    Properties:
      DBInstanceId:
        Fn::GetAtt:
          - ADBPGInstance
          - DBInstanceId
      AccountPassword:
        Ref: ADBPGPassword
      AccountName:
        Ref: ADBPGAccount
  AckModule:
    Version: default
    Type: MODULE::SHARE::1853370294850618::AckOrAcsCluster
    Properties:
      EnableDualZones: true
      EnableAutoScaling:
        Ref: AutoScalingOption
      PayType:
        Ref: PayType
      PayPeriod:
        Ref: PayPeriod
      PayPeriodUnit:
        Ref: PayPeriodUnit
      CsOptions:
        Ref: AckOptions
      VpcId:
        Fn::GetAtt:
          - VpcModule
          - VpcId
      ServiceCidr:
        Ref: ServiceCidr
      WorkerInstanceTypes:
        Ref: InstanceType
      ZoneIdSecondary:
        Ref: ZoneId2
      ClusterId:
        Ref: ClusterId
      ZoneId:
        Ref: ZoneId1
      WorkerSystemDiskSize:
        Ref: WorkerSystemDiskSize
      AckNetworkPlugin:
        Ref: AckNetworkPlugin
      VSwitchIdSecondary:
        Fn::GetAtt:
          - VpcModule
          - VSwitchIdSecondary
      VSwitchId:
        Fn::GetAtt:
          - VpcModule
          - VSwitchId
      PodVSwitchId:
        Fn::GetAtt:
          - VpcModule
          - VSwitchId
      PodVSwitchIdSecondary:
        Fn::GetAtt:
          - VpcModule
          - VSwitchIdSecondary
      WorkerSystemDiskCategory:
        Ref: WorkerSystemDiskCategory
      LoginPassword:
        Ref: InstancePassword
      WorkerInstanceCount:
        Ref: WorkerInstanceCount
      WorkerInstanceMinCount:
        Ref: WorkerInstanceMinCount
      WorkerInstanceMaxCount:
        Ref: WorkerInstanceMaxCount
  ACKAddons:
    Type: ALIYUN::CS::ClusterAddons
    Properties:
      ClusterId:
        Fn::GetAtt:
          - AckModule
          - ClusterId
      InstalledIgnore: true
      Addons:
        - Name: nginx-ingress-controller
        - Name: ack-node-local-dns
        - Name: logtail-ds
          Config: '{"IngressDashboardEnabled":"true"}'
  Sleep:
    Type: ALIYUN::ROS::Sleep
    DependsOn:
      - AckModule
      - ACKAddons
      - PostgreSQLInstance
      - RedisInstance
      - ADBPGInstance
    Properties:
      CreateDuration: 60
  ClusterAppliaction:
    Type: ALIYUN::CS::ClusterApplication
    Condition: EnableTLSConfigConditions
    DependsOn:
      - Sleep
    Properties:
      DefaultNamespace: dify-system
      YamlContent:
        Fn::Sub:
          - |
            apiVersion: v1
            kind: Secret
            type: IngressTLS
            metadata:
              name: dify-tls-secrets
              namespace: dify-system
            data:
              tls.crt: ${TLSCertString}
              tls.key: ${TLSSecretString}
          - TLSCertString:
              Fn::Base64Encode:
                Ref: TLSCert
            TLSSecretString:
              Fn::Base64Encode:
                Ref: TLSSecret
      ClusterId:
        Fn::GetAtt:
          - AckModule
          - ClusterId
  AckDify:
    Type: MODULE::ACS::ComputeNest::FluxOciHelmDeploy
    Version: default
    DependsOn: Sleep
    Properties:
      Namespace: dify-system
      HelmChartUrl: '{{ computenest::helmchart::dify }}'
      DockerConfigJson: '{{ computenest::helm::dockerconfigjson }}'
      ClusterId:
        Fn::GetAtt:
          - AckModule
          - ClusterId
      ReleaseName: ack-dify
      WaitUntil:
        Fn::If:
          - EnableHPAConditions
          - - Kind: Deployment
              Name: ack-dify-api
              Namespace: dify-system
              JsonPath: $.status.readyReplicas
              Operator: Equals
              Value: '2'
              ValueType: Json
              FirstMatch: true
              Timeout: 300
          - - Kind: Deployment
              Name: ack-dify-api
              Namespace: dify-system
              JsonPath: $.status.readyReplicas
              Operator: Equals
              Value: '1'
              ValueType: Json
              FirstMatch: true
              Timeout: 300
      ChartValues:
        Fn::MergeMap:
          - Ref: HelmValues
          - repository:
              Ref: Repo
            namespace: dify-system
            image:
              api:
                repo:
                  Ref: Repo
                image: dify-api
              web:
                repo:
                  Ref: Repo
                image: dify-web
              sandbox:
                repo:
                  Ref: Repo
                image: dify-sandbox
              pluginDaemon:
                image: dify-plugin-daemon
                repo:
                  Ref: Repo
              proxy:
                repo:
                  Ref: Repo
                image: nginx
              ssrfProxy:
                repo:
                  Ref: Repo
                image: squid
            api:
              enabled: true
              replicas:
                Fn::If:
                  - EnableHPAConditions
                  - 2
                  - 1
              resources: { }
              lifecycle: { }
              readinessProbe: { }
              livenessProbe: { }
              startupProbe: { }
              nodeSelector: { }
              affinity:
                Fn::If:
                  - EnableHPAConditions
                  - podAntiAffinity:
                      preferredDuringSchedulingIgnoredDuringExecution:
                        - weight: 100
                          podAffinityTerm:
                            labelSelector:
                              matchExpressions:
                                - key: component
                                  operator: In
                                  values:
                                    - api
                            topologyKey: kubernetes.io/hostname
                  - { }
              tolerations: [ ]
              extraEnv:
                - name: CHECK_UPDATE_URL
                  value: ''
                - name: CODE_MAX_NUMBER
                  value: '9223372036854775807'
                - name: CODE_MIN_NUMBER
                  value: '-9223372036854775808'
                - name: CODE_MAX_STRING_LENGTH
                  value: '80000'
                - name: TEMPLATE_TRANSFORM_MAX_LENGTH
                  value: '80000'
                - name: CODE_MAX_STRING_ARRAY_LENGTH
                  value: '30'
                - name: CODE_MAX_OBJECT_ARRAY_LENGTH
                  value: '30'
                - name: CODE_MAX_NUMBER_ARRAY_LENGTH
                  value: '1000'
                - name: CODE_MAX_DEPTH
                  value: '5'
                - name: CODE_MAX_PRECISION
                  value: '20'
              service:
                port: 5001
                annotations: { }
                labels: { }
                clusterIP: ''
              logLevel: INFO
              url:
                consoleApi: ''
                consoleWeb: ''
                serviceApi: ''
                appApi: ''
                appWeb: ''
                files: ''
                marketplace: https://marketplace.dify.ai
                marketplaceApi: https://marketplace.dify.ai
              mail:
                defaultSender: 'YOUR EMAIL FROM (eg: no-reply <no-reply@dify.ai>)'
                type: resend
                resend:
                  apiKey: xxxx
                  apiUrl: https://api.resend.com
                smtp:
                  server: smtp.server.com
                  port: 465
                  username: YOUR EMAIL
                  password: YOUR EMAIL PASSWORD
                  tls:
                    enabled: true
                    optimistic: false
              migration: true
              secretKey: sk-9f73s3ljTXVcMT3Blb3ljTqtsKiGHXVcMT3BlbkFJLK7U
              persistence:
                mountPath: /app/api/storage
                annotations:
                  helm.sh/resource-policy: keep
                persistentVolumeClaim:
                  existingClaim: ''
                  storageClass: alibabacloud-cnfs-nas
                  accessModes: ReadWriteMany
                  size: 50Gi
                  subPath: ''
            worker:
              enabled: true
              replicas:
                Fn::If:
                  - EnableHPAConditions
                  - 2
                  - 1
              resources: { }
              lifecycle: { }
              readinessProbe: { }
              livenessProbe: { }
              startupProbe: { }
              nodeSelector: { }
              affinity:
                Fn::If:
                  - EnableHPAConditions
                  - podAntiAffinity:
                      preferredDuringSchedulingIgnoredDuringExecution:
                        - weight: 100
                          podAffinityTerm:
                            labelSelector:
                              matchExpressions:
                                - key: component
                                  operator: In
                                  values:
                                    - worker
                            topologyKey: kubernetes.io/hostname
                  - { }
              tolerations: [ ]
              extraEnv: Null
              logLevel: INFO
              autoscaling:
                enabled:
                  Fn::If:
                    - EnableHPAConditions
                    - true
                    - false
                minReplicas: 1
                maxReplicas: 5
                metrics:
                  - type: Resource
                    resource:
                      name: memory
                      target:
                        averageUtilization: 80
                        type: Utilization
            proxy:
              enabled: true
              replicas: 1
              resources: { }
              lifecycle: { }
              readinessProbe: { }
              livenessProbe: { }
              startupProbe: { }
              nodeSelector: { }
              affinity: { }
              tolerations: [ ]
              proxyConf: ''
              nginxConf: ''
              defaultConf: ''
              extraEnv: Null
              log:
                persistence:
                  enabled: false
                  mountPath: /var/log/nginx
                  annotations:
                    helm.sh/resource-policy: keep
                  persistentVolumeClaim:
                    existingClaim: ''
                    storageClass: ''
                    accessModes: ReadWriteMany
                    size: 20Gi
                    subPath: ''
              service:
                port: 80
                annotations: { }
                labels: { }
                clusterIP: ''
            web:
              enabled: true
              replicas:
                Fn::If:
                  - EnableHPAConditions
                  - 2
                  - 1
              resources: { }
              lifecycle: { }
              readinessProbe: { }
              livenessProbe: { }
              startupProbe: { }
              nodeSelector: { }
              affinity:
                Fn::If:
                  - EnableHPAConditions
                  - podAntiAffinity:
                      preferredDuringSchedulingIgnoredDuringExecution:
                        - weight: 100
                          podAffinityTerm:
                            labelSelector:
                              matchExpressions:
                                - key: component
                                  operator: In
                                  values:
                                    - web
                            topologyKey: kubernetes.io/hostname
                  - { }
              tolerations: [ ]
              extraEnv:
                - name: EDITION
                  value: SELF_HOSTED
              service:
                port: 3000
                annotations: { }
                labels: { }
                clusterIP: ''
            sandbox:
              enabled: true
              replicas:
                Fn::If:
                  - EnableHPAConditions
                  - 2
                  - 1
              resources: { }
              lifecycle: { }
              readinessProbe: { }
              livenessProbe: { }
              startupProbe: { }
              nodeSelector: { }
              affinity:
                Fn::If:
                  - EnableHPAConditions
                  - podAntiAffinity:
                      preferredDuringSchedulingIgnoredDuringExecution:
                        - weight: 100
                          podAffinityTerm:
                            labelSelector:
                              matchExpressions:
                                - key: component
                                  operator: In
                                  values:
                                    - sandbox
                            topologyKey: kubernetes.io/hostname
                  - { }
              tolerations: [ ]
              extraEnv:
                - name: WORKER_TIMEOUT
                  value: '15'
              service:
                port: 8194
                annotations: { }
                labels: { }
                clusterIP: ''
              auth:
                apiKey: dify-sandbox
              privileged: false
            ssrfProxy:
              enabled: false
              replicas: 1
              resources: { }
              nodeSelector: { }
              affinity: { }
              tolerations: [ ]
              extraEnv: Null
              log:
                persistence:
                  enabled: false
                  mountPath: /var/log/squid
                  annotations:
                    helm.sh/resource-policy: keep
                  persistentVolumeClaim:
                    existingClaim: ''
                    storageClass: ''
                    accessModes: ReadWriteMany
                    size: 20Gi
                    subPath: ''
              service:
                port: 3128
                annotations: { }
                labels: { }
                clusterIP: ''
            pluginDaemon:
              affinity: {}
              auth:
                difyApiKey: QaHbTe77CtuXmsfyhR7+vRjI/+XbV1AaFy691iy+kGDv2Jvy0/eAh8Y1
                serverKey: lYkiYYT6owG+71oLerGzA7GXCgOT++6ovaezWAjpCjf+Sjc3ZtU+qUEi
              containerSecurityContext: {}
              customLivenessProbe: {}
              customReadinessProbe: {}
              customStartupProbe: {}
              enabled: true
              extraEnv: null
              marketplace:
                apiProxyEnabled: false
                enabled: true
              nodeSelector: {}
              persistence:
                annotations:
                  helm.sh/resource-policy: keep
                mountPath: /app/storage
                persistentVolumeClaim:
                  accessModes: ReadWriteOnce
                  existingClaim: ""
                  size: 20Gi
                  storageClass: alicloud-disk-topology-alltype
                  subPath: ""
              podSecurityContext: {}
              replicas: 1
              resources: {}
              service:
                annotations: {}
                clusterIP: ""
                labels: {}
                ports:
                  daemon: 5002
                  pluginInstall: null
              serviceAccount:
                annotations: {}
                automountServiceAccountToken: false
                create: false
                name: ""
              tolerations: []
            service:
              type: ClusterIP
              port: 80
            ingress:
              enabled:
                Fn::If:
                  - CreateAck
                  - true
                  - false
              className: ''
              annotations: { }
              hosts:
                - host:
                    Ref: DomainAddress
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: ack-dify
                          port: 80
              tls:
                Fn::If:
                  - EnableTLSConfigConditions
                  - - secretName: dify-tls-secrets
                      hosts:
                        - Ref: DomainAddress
                  - [ ]
            resources: { }
            nodeSelector: { }
            tolerations: [ ]
            affinity: { }
            externalAliyunOSS:
              enabled: true
              endpoint: 
                Fn::Sub:
                  - 'oss-${RegionId}.aliyuncs.com'
                  - RegionId:
                      Ref: ALIYUN::Region
              bucketName: 
                Fn::Join:
                  - '-'
                  - - 'dify'
                    - Ref: ALIYUN::StackName
              accessKey: 
                Fn::GetAtt:
                  - AccessKey
                  - AccessKeyId
              secretKey: 
                Fn::GetAtt:
                  - AccessKey
                  - AccessKeySecret
              region: 
                Ref: ALIYUN::Region
              authVersion: v4
              path: your-path
            externalPostgres:
              enabled: true
              username:
                Ref: PostgresSQLUserName
              password:
                Ref: PostgresSQLPassword
              address:
                Fn::GetAtt:
                  - PostgreSQLInstance
                  - InnerConnectionString
              port: 5432
              dbName: dify
              maxOpenConns: 20
              maxIdleConns: 5
            externalRedis:
              enabled: true
              host:
                Fn::GetAtt:
                  - RedisInstance
                  - ConnectionDomain
              port: 6379
              username: ''
              password:
                Ref: RedisInstancePassword
              useSSL: false
            externalAnalyticDB:
              enabled: true
              accessKey:
                Fn::GetAtt:
                  - AccessKey
                  - AccessKeyId
              secretKey:
                Fn::GetAtt:
                  - AccessKey
                  - AccessKeySecret
              region:
                Ref: ALIYUN::Region
              instanceId:
                Fn::GetAtt:
                  - ADBPGInstance
                  - DBInstanceId
              account:
                Ref: ADBPGAccount
              accountPassword:
                Ref: ADBPGPassword
              namespace: difyns
              namespacePassword: difypassword
            postgresql:
              enabled: false
            weaviate:
              enabled: false
            redis:
              enabled: false
  NginxIngressResources:
    Type: DATASOURCE::CS::ClusterApplicationResources
    Condition: CreateAck
    DependsOn:
      - Sleep
    Properties:
      Namespace: kube-system
      Kind: Service
      ApiVersion: v1
      JsonPath: $.status.loadBalancer.ingress[0].ip
      ClusterId:
        Fn::GetAtt:
          - AckModule
          - ClusterId
      Name: nginx-ingress-lb
Outputs:
  Dify访问页面:
    Label: Dify访问页面
    Condition: CreateAck
    Value:
      Fn::Sub:
        - ${Protocol}://${Address}/install
        - Protocol:
            Fn::If:
              - EnableTLSConfigConditions
              - https
              - http
          Address:
            Ref: DomainAddress
  请配置到域名解析或hosts中:
    Label: 请配置到域名解析或hosts中
    Condition: CreateAck
    Value:
      Fn::Sub:
        - ${IpAddress} ${Address}
        - IpAddress:
            Fn::Select:
              - 0
              - Fn::GetAtt:
                  - NginxIngressResources
                  - Response
          Address:
            Ref: DomainAddress
  请到ACK集群中配置服务访问:
    Label: 请到ACK集群中配置服务访问
    Condition: ExistedAck
    Value: 为ACK集群中dify-system命名空间下的Service:ack-dify 配置服务访问，可通过配置负载均衡、或者Ingress的方式开启公网访问。详情请参考部署说明文档。
Metadata:
  ALIYUN::ROS::Interface:
    ParameterGroups:
      - Parameters:
          - PayType
          - PayPeriodUnit
          - PayPeriod
        Label:
          default:
            en: PayType Configuration
            zh-cn: 付费类型配置
      - Parameters:
          - AckOptions
          - ClusterId
          - InstanceType
          - WorkerSystemDiskCategory
          - WorkerSystemDiskSize
          - InstancePassword
          - AutoScalingOption
          - WorkerInstanceCount
          - WorkerInstanceMinCount
          - WorkerInstanceMaxCount
          - AckNetworkPlugin
          - ServiceCidr
          - PodCidr
        Label:
          default:
            en: Kubernetes Configuration
            zh-cn: Kubernetes配置
      - Parameters:
          - DBInstanceClass
          - DBInstanceStorageType
          - DBInstanceStorage
          - PostgresSQLUserName
          - PostgresSQLPassword
        Label:
          default:
            en: Postgres Database Configuration
            zh-cn: Postgres 数据库配置
      - Parameters:
          - RedisInstancePassword
        Label:
          default:
            en: Redis Database Configuration
            zh-cn: Redis数据库配置
      - Parameters:
          - ADBPGInstanceSpec
          - ADBPGSegmentStorage
          - ADBPGAccount
          - ADBPGPassword
        Label:
          default:
            en: Vector Database Configuration
            zh-cn: 向量数据库配置
      - Parameters:
          - VpcOption
          - ZoneId1
          - ZoneId2
          - VpcCidrBlock
          - VSwitchCidrBlock1
          - VSwitchCidrBlock2
          - VpcId
          - VSwitchId1
          - VSwitchId2
        Label:
          default:
            zh-cn: 基础配置
            en: Basic Configuration
      - Parameters:
          - DomainAddress
          - EnableTLSConfig
          - TLSCert
          - TLSSecret
          - HPAOption
          - HelmValues
        Label:
          default:
            zh-cn: 服务配置
            en: Service Configuration
